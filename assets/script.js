// Все вопросы по Основам управления проектами (46 вопросов)
const PM_QUESTIONS = [
  {q: 'При проведении качественного анализа рисков были получены следующие атрибуты одного из рисков: вероятность = 55%, влияние = 20%. К какой из категории матрицы рангов относится данный риск?', opts: ['«Собаки»', '«Львы»', '«Тигры»', '«Мыши»', '«Кошки»'], a: 1, explain: 'Правильный ответ: «Львы»'},
  {q: 'При проведении качественного анализа рисков были получены следующие атрибуты одного из рисков: вероятность = 57%, влияние = 58%. К какой из категории матрицы рангов относится данный риск?', opts: ['«Мыши»', '«Кошки»', '«Тигры»', '«Львы»', '«Собаки»'], a: 2, explain: 'Правильный ответ: «Тигры»'},
  {q: 'Назовите основную характеристику метода Delphi:', opts: ['Мнение эксперта', 'Экстраполяция исторической информации', 'Управление по принципу «сверху-вниз»', 'Численный процесс', 'Аналитический процесс'], a: 0, explain: 'Правильный ответ: Мнение эксперта'},
  {q: 'Для процесса разработки Устава проекта необходимы следующие внешние и внутренние для проекта элементы (входы), за исключением:', opts: ['Договор', 'Контракт', 'Активы организационного процесса', 'Содержание работ проекта', 'Методы выбора проекта'], a: 4, explain: 'Правильный ответ: Методы выбора проекта'},
  {q: 'Кто подписывает Устав проекта:', opts: ['Менеджер проекта', 'Команда управления проектом', 'Вышестоящий руководитель (спонсор, заказчик)', 'Функциональный менеджер', 'Офис управления проектом'], a: 2, explain: 'Правильный ответ: Вышестоящий руководитель (спонсор, заказчик)'},
  {q: 'Член команды проекта беседует с другим членом команды и жалуется на то, что многие сотрудники обращаются к нему с различными просьбами. Если этот сотрудник работает в функциональной организации, кто имеет право давать указания членам команды?', opts: ['Спонсор проекта', 'Заказчик', 'Команда', 'Менеджер проекта', 'Функциональный менеджер'], a: 4, explain: 'Правильный ответ: Функциональный менеджер'},
  {q: 'Руководитель менеджера проекта и руководитель технического отдела обсуждают изменения основного задания. После встречи начальник обращается к менеджеру проекта и просит его внести изменения. Это пример:', opts: ['Позиции функционального менеджера', 'Позиции координатора проекта', 'Внимательного отношения руководства к управлению содержанием проекта', 'Позиции линейного менеджера', 'Позиции спонсора проекта'], a: 1, explain: 'Правильный ответ: Позиции координатора проекта'},
  {q: 'Положительное значение SV означает -', opts: ['перерасход бюджета', 'опережение расписания', 'данная величина не относится к бюджету', 'недорасход бюджета', 'отставание от расписания'], a: 1, explain: 'Правильный ответ: опережение расписания'},
  {q: 'Бюджет по завершению работ обозначается как', opts: ['EAC', 'ETC', 'CPI', 'BAC', 'VAC'], a: 3, explain: 'Правильный ответ: BAC'},
  {q: 'Прогноз по завершению обозначается как', opts: ['SPI', 'BAC', 'CPI', 'VAC', 'EAC'], a: 4, explain: 'Правильный ответ: EAC'},
  {q: 'Индекс выполнения стоимости обозначается как', opts: ['EAC', 'ETC', 'BAC', 'CPI', 'VAC'], a: 3, explain: 'Правильный ответ: CPI'},
  {q: 'Во время какой фазы жизненного цикла управления проектом создается детальный бюджет проекта?', opts: ['Планирование', 'Исполнение', 'Мониторинг и управление', 'Инициация', 'Перед жизненным циклом управления проектом'], a: 0, explain: 'Правильный ответ: Планирование'},
  {q: 'Выходом из процесса планирования реагирования на риски является:', opts: ['Матрица рангов', 'Перечень приоритетных рисков', 'Идентифицированные последствия от наступления риска', 'Реестр рисков', 'Остаточные риски'], a: 3, explain: 'Правильный ответ: Реестр рисков'},
  {q: 'Назначен менеджер нового проекта с небольшим опытом работы. Так как для выполнения проекта он будет работать по матричной схеме организации, то можно ожидать, что обмен информацией будет:', opts: ['Комплексным', 'Открытым и точным', 'Трудно автоматизируемым', 'Легко автоматизируемым', 'Простым'], a: 0, explain: 'Правильный ответ: Комплексным'},
  {q: 'Кто имеет наибольшую власть в проектно-ориентированной организации?', opts: ['Все ответы правильные', 'Команда', 'Функциональный менеджер', 'Полномочия разделены между всеми', 'Менеджер проекта'], a: 4, explain: 'Правильный ответ: Менеджер проекта'},
  {q: 'Во время какой фазы жизненного цикла управления проектом создается Устав проекта?', opts: ['Планирование', 'Исполнение', 'Инициация', 'Контроль', 'Завершение'], a: 2, explain: 'Правильный ответ: Инициация'},
  {q: 'Устав должен содержать следующее, за исключением:', opts: ['Ограничения', 'Критерии успеха', 'Бюджет проекта', 'Объем вознаграждения спонсора, заказчика', 'Отношения между участниками проекта'], a: 3, explain: 'Правильный ответ: Объем вознаграждения спонсора, заказчика'},
  {q: 'Выберите формулу расчета VAC', opts: ['BAC-EAC', 'EV-PV', 'EV/PV', 'BAC/CPI', 'EAC-AC'], a: 0, explain: 'Правильный ответ: BAC-EAC'},
  {q: 'Расхождения при завершении обозначается как', opts: ['ETC', 'CPI', 'BAC', 'VAC', 'SPI'], a: 3, explain: 'Правильный ответ: VAC'},
  {q: 'Отклонение по срокам обозначается как', opts: ['PV', 'CV', 'EV', 'SV', 'AC'], a: 3, explain: 'Правильный ответ: SV'},
  {q: 'Выберите формулу расчета SV', opts: ['EV/AC', 'EV-AC', 'EV-PV', 'EV/PV', 'BAC/CPI'], a: 2, explain: 'Правильный ответ: EV-PV'},
  {q: 'Оценки продолжительности задания О=3 дня, Р=7 дней, М=4 дня. Каково стандартное отклонение этого задания', opts: ['5/6 дня', '1/2 дня', '2,5 дня', '2/3 дня', '1/3 дня'], a: 3, explain: 'Правильный ответ: 2/3 дня'},
  {q: 'В проектной организации команда проекта', opts: ['Не несет ответственности за проект', 'Все ответы правильные', 'Отчитывается перед несколькими руководителями', 'Отчитывается перед функциональным менеджером', 'никогда не будет иметь «собственного дома» (собственного отдела, в который она вернется после завершения проекта)'], a: 4, explain: 'Правильный ответ: никогда не будет иметь «собственного дома»'},
  {q: 'Что из перечисленного должен содержать Устав проекта?', opts: ['План управления коммуникациями', 'Деловые потребности проекта', 'Оценки заданий', 'План управления рисками', 'Подробные оценки ресурсов'], a: 1, explain: 'Правильный ответ: Деловые потребности проекта'},
  {q: 'Активы организационного процесса включают следующее, кроме:', opts: ['Процедуры финансового контроля', 'Требования к коммуникациям', 'Процессы и процедуры организации для проведения работ', 'Ситуация на рынке', 'Шаблоны'], a: 3, explain: 'Правильный ответ: Ситуация на рынке'},
  {q: 'Проект по разработке программного обеспечения идет непросто. В проекте свыше 30 участников и они не могут согласовать цели проекта. Один из участников проекта считает, что проект позволит достичь улучшения 30%, второй надеется, что возможно достичь 50%. Менеджер проекта считает, что 10% - наиболее реалистичны. Каков наилучший порядок действий?', opts: ['Все ответы правильные', 'Ускорить проект в надежде, что в ходе исполнения поступит больше информации, которая позволит решить вопрос', 'Выполнить анализ осуществимости', 'Усреднить эти цифры и использовать среднее как цель', 'Попросить спонсора вынести окончательное решение'], a: 2, explain: 'Правильный ответ: Выполнить анализ осуществимости'},
  {q: 'Положительное значение CV означает -', opts: ['отставание от расписания', 'недорасход бюджета', 'перерасход бюджета', 'данная величина не относится к бюджету', 'опережение расписания'], a: 1, explain: 'Правильный ответ: недорасход бюджета'},
  {q: 'Выберите формулу расчета ETC', opts: ['BAC-EAC', 'EAC-AC', 'EV-PV', 'BAC/CPI', 'EV/PV'], a: 1, explain: 'Правильный ответ: EAC-AC'},
  {q: 'Система кода счетов в иерархической структуре работ (ИСР) позволяет персоналу проекта:', opts: ['Систематически оценивать стоимость элементов ИСР', 'Определять уровень на котором находятся отдельные элементы', 'Проводить реабилитацию проекта', 'Систематически оценивать длительность элементов ИСР', 'Использовать ее в программных продуктах управления проектом'], a: 1, explain: 'Правильный ответ: Определять уровень на котором находятся отдельные элементы'},
  {q: 'Резерв задания определяется:', opts: ['С помощью метода Монте-Карло', 'Отставанием', 'Опережением', 'Временем ожидания между заданиями', 'Временем, на которое может быть задержано задание до того, как оно замедлит критический путь'], a: 4, explain: 'Правильный ответ: Временем, на которое может быть задержано задание до того, как оно замедлит критический путь'},
  {q: 'Если пессимистическая оценка продолжительности задания – 18 дней, а оптимистическая – 12 дней, чему равно стандартное отклонение задание?', opts: ['1 день', '1,3 дня', '6 дней', '2 дня', '3 дня'], a: 0, explain: 'Правильный ответ: 1 день'},
  {q: 'Плановый объем обозначается как', opts: ['EV', 'CV', 'AC', 'SV', 'PV'], a: 4, explain: 'Правильный ответ: PV'},
  {q: 'Отрицательное значение CV означает -', opts: ['данная величина не относится к бюджету', 'перерасход бюджета', 'отставание от расписания', 'опережение расписания', 'недорасход бюджета'], a: 1, explain: 'Правильный ответ: перерасход бюджета'},
  {q: 'Прогноз до завершения обозначается как', opts: ['VAC', 'SPI', 'CPI', 'ETC', 'EAC'], a: 3, explain: 'Правильный ответ: ETC'},
  {q: 'Стрелочная диаграмма отличается от узловой диаграммы, так как стрелочная диаграмма:', opts: ['Имеет зависимости только типа «окончание-окончание»', 'Имеет четыре зависимости между заданиями', 'Может включать фиктивные операции', 'Может использовать PERT', 'Имеет зависимости только типа «старт-старт»'], a: 2, explain: 'Правильный ответ: Может включать фиктивные операции'},
  {q: 'Какое высказывание наилучшим образом описывает взаимосвязь между стандартным отклонением и риском?', opts: ['Стандартное отклонение означает то, что оценка точная', 'Стандартное отклонение означает то, насколько неточна оценка', 'Стандартное отклонение означает то, что в оценку включена «раздутая смета»', 'Взаимосвязи нет', 'показывает вероятность наступления риска'], a: 1, explain: 'Правильный ответ: Стандартное отклонение означает то, насколько неточна оценка'},
  {q: 'Факторы внешней среды предприятия включают следующее, кроме:', opts: ['Погодные условия', 'Ситуация на рынке', 'Историческая информация', 'Организационная или корпоративная культура и структура', 'Толерантность к риску участников проекта'], a: 2, explain: 'Правильный ответ: Историческая информация'},
  {q: 'Все нижеприведенные характеристики являются признаками проекта, за исключением:', opts: ['Определение рисков проекта', 'Определенная дата начала и окончания', 'Временность', 'Повторяемость каждый месяц', 'Взаимосвязанные операции'], a: 3, explain: 'Правильный ответ: Повторяемость каждый месяц'},
  {q: 'Индекс выполнения сроков обозначается как', opts: ['VAC', 'CPI', 'BAC', 'ETC', 'SPI'], a: 4, explain: 'Правильный ответ: SPI'},
  {q: 'Выберите формулу расчета CV', opts: ['EV-AC', 'EV/AC', 'BAC/CPI', 'EV/PV', 'EV-PV'], a: 0, explain: 'Правильный ответ: EV-AC'},
  {q: 'Фактическая стоимость обозначается как', opts: ['AC', 'EV', 'PV', 'CV', 'SV'], a: 0, explain: 'Правильный ответ: AC'},
  {q: 'Одним из преимуществ матричной организации по сравнению с функциональной является:', opts: ['Более простая отчетность', 'Более простая структура проекта', 'Более чем один начальник у команд проекта', 'Более совершенный контроль менеджера проекта над ресурсами', 'Более простой обмен информацией'], a: 3, explain: 'Правильный ответ: Более совершенный контроль менеджера проекта над ресурсами'},
  {q: 'Выберите формулу расчета EAC', opts: ['EAC-AC', 'BAC/CPI', 'EV/PV', 'EV-PV', 'BAC-EAC'], a: 1, explain: 'Правильный ответ: BAC/CPI'},
  {q: 'Отрицательное значение SV означает -', opts: ['перерасход бюджета', 'отставание от расписания', 'опережение расписания', 'недорасход бюджета', 'данная величина не относится к бюджету'], a: 1, explain: 'Правильный ответ: отставание от расписания'},
  {q: 'При проведении качественного анализа рисков были получены следующие атрибуты одного из рисков: вероятность = 47%, влияние = 58%. К какой из категории матрицы рангов относится данный риск?', opts: ['«Кошки»', '«Собаки»', '«Тигры»', '«Мыши»', '«Львы»'], a: 1, explain: 'Правильный ответ: «Собаки»'},
  {q: 'Ваше руководство решило, что все заказы будут рассматриваться как «проекты», а менеджеры проектов должны обновлять заказы ежедневно, решая проблемы, и гарантируя, что заказчик официально примет продукцию в течение 30 дней после завершения. Доход от таких индивидуальных заказов может меняться от 100$ до 150000$. От менеджера проекта не требуется проводить планирование или предоставлять какую-либо другую информацию, кроме ежедневных отчетов. Как бы Вы определили эту ситуацию:', opts: ['Это операционная деятельность', 'Так как каждый индивидуальный заказ является временным, каждый заказ – это проект, следовательно - это настоящее управление проектами', 'Заказы, приносящие прибыль свыше 10000, рассматриваются как проекты, поэтому это управление проектами', 'Это программное управление, так как существует множество проектов', 'Это повторяющийся процесс'], a: 4, explain: 'Правильный ответ: Это повторяющийся процесс'}
];

const QUESTIONS = [...PM_QUESTIONS];
const SOURCE_HTML = 'Тесты для подговки к экзамену-1.htm';
let idx = 0;
const container = document.getElementById('q-container');
const progressBar = document.getElementById('q-progress');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
let QUIZ = [...QUESTIONS];
const restartBtn = document.getElementById('restartBtn');
const importFile = document.getElementById('importFile');
const countEl = document.getElementById('q-count');
let autoTimer = null;
function updateProgress(){
  const el = progressBar.querySelector('i') || document.createElement('i');
  if(!progressBar.contains(el)) progressBar.appendChild(el);
  const pct = QUIZ.length ? Math.round(((idx)/QUIZ.length)*100) : 0;
  el.style.width = pct + '%';
  progressBar.setAttribute('data-label', QUIZ.length ? `${idx+1}/${QUIZ.length}` : '0/0');
}
function renderQuestion(){
  if(autoTimer){ clearTimeout(autoTimer); autoTimer = null; }
  container.innerHTML = '';
  if(!QUIZ.length){
    const empty = document.createElement('div');
    empty.className = 'question';
    empty.textContent = 'Вопросы не найдены';
    container.appendChild(empty);
    updateProgress();
    return;
  }
  const data = QUIZ[idx];
  const q = document.createElement('div'); q.className = 'question'; q.textContent = (idx+1)+'. '+data.q; container.appendChild(q);
  const opts = document.createElement('div'); opts.className = 'options';
  data.opts.forEach((text,i)=>{
    const b = document.createElement('button'); b.className='option'; b.dataset.i = i; b.type = 'button'; b.setAttribute('aria-pressed','false');
    b.innerHTML = `<span class=\"chip\">${String.fromCharCode(65+i)}</span><span class=\"text\">${escapeHtml(text)}</span>`;
    b.addEventListener('click',()=> onChoose(b,i));
    opts.appendChild(b);
  });
  container.appendChild(opts);
  updateProgress();
}
function onChoose(btn,i){
  const data = QUIZ[idx];
  const parent = btn.parentElement;
  if(parent.dataset.answered) return;
  parent.dataset.answered = '1';
  const children = Array.from(parent.children);
  children.forEach(c=> c.classList.add('disabled'));
  if(i === data.a){
    btn.classList.add('correct'); btn.setAttribute('aria-pressed','true');
    autoTimer = setTimeout(()=>{
      if(idx < QUIZ.length-1){ idx++; renderQuestion(); }
    }, 1500);
  } else {
    btn.classList.add('wrong'); btn.setAttribute('aria-pressed','true');
    const correct = children.find(c=> Number(c.dataset.i) === data.a);
    if(correct) correct.classList.add('correct');
  }
  const ex = document.createElement('div'); ex.className='explain'; ex.textContent = data.explain || '';
  container.appendChild(ex);
}
prevBtn.addEventListener('click',()=>{
  if(autoTimer){ clearTimeout(autoTimer); autoTimer = null; }
  if(idx>0) { idx--; renderQuestion(); }
});
nextBtn.addEventListener('click',()=>{
  if(autoTimer){ clearTimeout(autoTimer); autoTimer = null; }
  if(idx<QUIZ.length-1) { idx++; renderQuestion(); }
  else { idx = 0; renderQuestion(); }
});
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } }
function updateCount(){ if(countEl) countEl.textContent = QUIZ.length ? ('Всего: '+QUIZ.length) : ''; }
restartBtn.addEventListener('click',()=>{ shuffle(QUIZ); idx=0; renderQuestion(); updateCount(); });
importFile.addEventListener('change', async (e)=>{
  const file = e.target.files && e.target.files[0];
  if(!file) return;
  const text = await file.text();
  const parsed = parseWordHtmlToQuestions(text);
  if(parsed.length){ QUIZ = parsed; idx=0; renderQuestion(); updateCount(); }
  else { alert('Не удалось распознать вопросы из файла.'); }
});
function parseWordHtmlToQuestions(html){
  const dom = new DOMParser().parseFromString(html,'text/html');
  const out = [];
  const text = (el)=> (el?.textContent || '').replace(/\s+/g,' ').trim();

  const tables = dom.querySelectorAll('table');
  tables.forEach(tbl=>{
    const rows = tbl.querySelectorAll('tr');
    rows.forEach(row=>{
      const cells = Array.from(row.querySelectorAll('td,th'));
      // Основная структура из экспортированного Word: вопрос в 3-й ячейке, правильный ответ в 4-й
      if(cells.length >= 7){
        const q = text(cells[2]);
        const answers = [cells[3], cells[4], cells[5], cells[6]].map(text).filter(Boolean);
        if(q && answers.length === 4){
          const correct = answers[0];
          const shuffled = [...answers];
          shuffle(shuffled);
          const a = Math.max(0, shuffled.indexOf(correct));
          out.push({q, opts: shuffled, a, explain: `Правильный ответ: ${correct}`});
          return;
        }
      }
      // Базовая структура (вопрос в первой колонке, варианты в следующих четырех)
      if(cells.length >= 5){
        const q = text(cells[0]);
        const opts = cells.slice(1,5).map(c=> text(c)).filter(Boolean);
        let a = 0;
        for(let k=1;k<=4;k++){
          const cell = cells[k];
          const hasBold = cell.querySelector('b,strong');
          const style = (cell.getAttribute('style')||'').toLowerCase();
          if(hasBold || style.includes('color:green') || style.includes('#00ff00')) { a = k-1; break; }
        }
        if(q && opts.length===4){ out.push({q,opts,a,explain:''}); }
      }
    });
  });
  if(!out.length){
    const ps = Array.from(dom.querySelectorAll('p'));
    for(let i=0;i<ps.length;i++){
      const q = ps[i].textContent.trim();
      const opts = [];
      for(let j=1;j<=4 && i+j<ps.length;j++){ opts.push(ps[i+j].textContent.trim()); }
      if(q && opts.length===4){ out.push({q,opts,a:0,explain:''}); i += 4; }
    }
  }
  return out;
}

async function loadDefaultHtml(){
  // Сначала загружаем встроенные вопросы из PM_QUESTIONS
  if(PM_QUESTIONS && PM_QUESTIONS.length > 0){
    QUIZ = [...PM_QUESTIONS];
    idx = 0;
    shuffle(QUIZ);
    renderQuestion();
    updateCount();
    return;
  }
  
  // Если встроенных вопросов нет, пробуем загрузить из HTML
  try{
    const res = await fetch(encodeURI(SOURCE_HTML));
    if(!res.ok) throw new Error('source not found');
    const html = await res.text();
    const parsed = parseWordHtmlToQuestions(html);
    if(parsed.length){
      QUIZ = parsed;
      idx = 0;
      shuffle(QUIZ);
      renderQuestion();
      updateCount();
      return;
    }
  } catch(err){
    console.warn('Не удалось загрузить вопросы из HTML:', err);
  }
  renderQuestion();
  updateCount();
}

updateProgress();
loadDefaultHtml();
window.QUIZ = {QUESTIONS, QUIZ};

function escapeHtml(str){
  return String(str)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'",'&#039;');
}
